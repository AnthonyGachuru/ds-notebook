# Code Snippets

## Python

### General

* https://chrisalbon.com/

* pandas: isin | crosstab

* pd.group_by aggregate functions: size, count, sum, mean, median, sd, var, min, max, prod, first, last

* The only float that isn't equal to itself is nan.

* %matplotlib notebook: interactive plots

* Memory storage: use pd.copy to create a deep copy instead of a shallow copy

* IPy: %who or %whos shows defined variables & %reset resets them

* Append dict to df: use ignore_index = True. eg. films_df = films_df.append(film_dict, ignore_index=1)

* Debugging: import pdb | pdb.set_trace(), 

* dir() gives a list of in scope variables

* globals() gives a dictionary of global variables

* locals() gives a dictionary of local variables

* https://bugra.github.io/work/notes/2015-01-03/i-wish-i-knew-these-things-when-i-first-learned-python/

* np.dot = np.multiply %>% np.sum

* flatten dict

    * pd.io.json.json_normalize(stuff)
    *https://stackoverflow.com/questions/6027558/flatten-nested-python-dictionaries-compressing-keys/41689055#41689055
    * https://towardsdatascience.com/flattening-json-objects-in-python-f5343c794b10
    

### Vanderplas Jupyter

* create helper functions and units tests as R/py for Rmd/ipynb

* pytest/hypothesis for testing

* use makefile to run cmd commands

* Write file with date: df.to_csv('{}_model.csv'.format(str(datetime.datetime.now()).split(' ')[0]))

* Make package for workflow with data (__init__.py) and use this formation for function docs:

```{python, eval = FALSE}
def fun(a):

  #Role
  #-----
  #Does something
  
  #Parameters
  #---------
  #Accepts something
  
  #Returns
  #-------
  #Returns something
  
  return(a)
```

    
### Masking Array
    
You can mask your array using the numpy.ma.array function and subsequently apply any numpy operation:

```{python, eval = FALSE}
import numpy as np

a = np.random.rand(10)            # Generate random data.
a = np.where(a > 0.8, np.nan, a)  # Set all data larger than 0.8 to NaN

a = np.ma.array(a, mask=np.isnan(a)) # Use a mask to mark the NaNs

a_norm  = a / np.sum(a) # The sum function ignores the masked values.
a_norm2 = a / np.std(a) # The std function ignores the masked values.

a.data
```

### Showing Data With Plotly

```{python, eval = FALSE}
# plotly display data

from plotly.tools import FigureFactory as ff
import plotly
import pandas as pd
plotly.offline.init_notebook_mode()
df = pd.read_csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_usa_states.csv')
table = ff.create_table(df.iloc[1:10, 1:5])
plotly.offline.plot(table, output_type = 'div', show_link = False, include_plotlyjs = False)
```

### Hyperband Cross Validation

```{python, eval = FALSE}
from civismlext.hyperband import HyperbandSearchCV
#https://github.com/civisanalytics/civisml-extensions/blob/master/civismlext/hyperband.py
```

### Pandas Display Options

```{python, eval = FALSE}
# Display floats with 2 decimal places
pd.options.display.float_format = '{:,.2f}'.format
 
# Expand display limits
pd.options.display.max_rows = 200
pd.options.display.max_columns = 100
```

### Infix Operators

```{python, eval = FALSE}
# Define new operator

class Infix:
    def __init__(self, function):
        self.function = function
    def __ror__(self, other):
        return Infix(lambda x, self = self, other = other: self.function(other, x))
    def __or__(self, other):
        return self.function(other)
    def __rlshift__(self, other):
        return Infix(lambda x, self=self, other=other: self.function(other, x))
    def __rshift__(self, other):
        return self.function(other)
    def __call__(self, value1, value2):
        return self.function(value1, value2)

pipe = Infix(lambda x,y: y(x))
4 |pipe| (lambda z: z**2)
```

### Generators

```{python, eval = FALSE}
# Generators Error

iterator = iter(iterable)
try:
    while True:
        item = next(iterator)
        do_stuff(item)
except StopIteration:
    pass
finally:
    del iterator
```

### Rowwise Operations In Pandas

```{python, eval = FALSE}
# Apply a function to every row in a pandas dataframe

rectangles = [
    { 'height': 40, 'width': 10 },
    { 'height': 20, 'width': 9 },
    { 'height': 3.4, 'width': 4 }
]

rectangles_df = pd.DataFrame(rectangles)

def calculate_area(row):
    return row['height'] * row['width']

rectangles_df.apply(calculate_area, axis=1)

# Apply to single column

df['SAL-RATE'].apply(money_to_float)
```

### Additional Functions Args In Map

```{python, eval = FALSE}
# Extra arguments to function

import functools

def add(x, y):
    return x + y
    
a = [1, 2, 3]
map(functools.partial(add, y=2), a)
```

### Check CSV Encoding

```{python, eval = F}
with open("../input/kickstarter-projects/ks-projects-201801.csv", 'rb') as rawdata:
    result = chardet.detect(rawdata.read(10000))
```

### MNIST Example

```{python, eval = FALSE}
import matplotlib.pyplot as plt
from sklearn import datasets
from sklearn import svm

digits = datasets.load_digits()

#print(digits.data)
#print(digits.target)
print(digits.images[0])

clf = svm.SVC(gamma=.001,C=100)
x, y = digits.data[:-10], digits.target[:-10]

clf.fit(x,y)
print("Prediction: ", clf.predict(digits.data[-2].reshape(1, -1)))

plt.imshow(digits.images[-2], cmap=plt.cm.gray_r, interpolation="nearest")
plt.show()
```

## R

### General

* ctrl + shift + a: reformat code in rstudio

* rowwise in R: purrr::pmap

* YearMonth = firstScheduledDay %>% strftime(format="%Y-%m")

* str_split + unnest()

* https://stat.ethz.ch/R-manual/R-devel/library/base/html/Last.value.html

* na_if: Replace certain values by na

* purrr::map_df - map over columns

* studio multiple cursors, snippets,  addins

* ctrl + shift + o: toggle table of contents

* ctrl shift enter: run chunk

* ctrl pageup/down: navigate chunks

* atl shift k: shortcuts

* ctrl + shift + R: label sections

* ctrl + alt + R: run all chunks

* df_print: kable in yaml rmrkdown header

* rm(list = ls()): Remove all objects in the current workspace

* cut(): Transform a numeric variable into a categorical variable.

* car: recode (good for dummying)

* Examine the objects in the workspace: ls.str()

* This is how you dynamically update a value in Rmarkdown: x = *backtick* r x *backtick*. 

### R for Everything Talk

* dir.exists | dir.create | download.file

* untar | unlink | file.info

* dir | file.rename | file.copy

* count.fields | system

* dplyr five main actions: select, filter, arrange, mutate, summarize.

### Pipe Anonymous Function

```{r,eval = F}
data %>%
  (function(input.object) {
    complex
    logic
    goes
    here
    output.object
  })
```

### Binarize  Predictions

```{r, eval = F}
clf_lr_final <- clf_lr$finalModel
model_tidy <- broom::tidy(clf_lr_final)
df2$pass_predicted <- as.factor(
  ifelse(clf_lr_final$fitted.values >= .5, 'pass', 'fail')
  )
metrics(df2, pass, pass_predicted)

var_imp <- varImp(clf_lr_final) %>% mutate(cols = row.names(.)) %>% arrange(-Overall) %>% select(cols, Overall)
var_imp
```

### Make Formula

```{r}
make_formula <- function(target, additions, subtractions = NULL, powers = NULL){
  
  add_sub_sep = ifelse(is.null(subtractions), '', '-')
  add <- paste0(additions, collapse = ' + ')
  subtract <- paste0(subtractions, collapse = ' - ')
  add_subtract <- paste(add, subtract, sep = add_sub_sep)
  
  return(as.formula(paste(target, add_subtract, sep = '~')))
  
}
```

### Shiny Reactive

```{r, eval = FALSE}
df_labeled = eventReactive({c(input$good, input$bad)}, {    
    df %>% filter(value == input$value)
  })
```

### Custom Theme

```{r, eval=F}
theme(
     axis.text.y = element_text(angle = 65, vjust = 0.6),
     axis.title.x = element_blank(),
     panel.background = element_blank()
     )
```

### Create Factor

```{r, eval=F}
mons = factor(
   c("August","September", "October","November",
           "December", "January","February","March",
               "April","May","June","July"),
  levels = c("August","September", "October","November",
           "December", "January","February","March",
               "April","May","June","July"),
  ordered = TRUE)
```

### Extract Date

```{r, eval = F}
LessonStartTime %>% as.POSIXct() %>% strftime(format="%Y-%m-%d")
```

### Geom_Path

```{r, eval=F}
ggplot(ilo_data) +
  geom_path(
            aes(x = working_hours, y = country),
            arrow = arrow(length = unit(1.5, "mm"), type = "closed")
)
```

### Theme Template

```{r, eval = F}
theme_ilo <- function() {
  theme_minimal() +
  theme(
    text = element_text(family = "Bookman", color = "gray25"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(color = "gray30"),
    plot.background = element_rect(fill = "gray95"),
    plot.margin = unit(c(5, 10, 5, 10), units = "mm")
  )
}
```

### Heatmap

```{r, eval = F}
library(corrplot)
df_fltrd %>% select_if(is.numeric) %>%  
cor() %>% corrplot(method = "circle", is.corr = FALSE)
```

### Calculate Accuracy

```{r, eval = FALSE}
calc_accuracy <- function(labels, preds){
  
  results <- table(labels, preds) %>% 
    data.frame %>%
    mutate(correct = ifelse(labels==preds, 1, 0)) %>%
    group_by(correct) %>% 
    summarise(freq = sum(Freq)) %>% 
    ungroup() %>%
    mutate(prop = freq/sum(freq)) %>%
    filter(correct == 1)
  
  return(results)

}
```

### Replace NA

```{r, eval=F}
df %>% replace_na(list(x = 0, y = "unknown"))
df2 %>% replace(., is.na(.), "")
```

### Filter By Row

```{r, eval = FALSE}
df %>%
  filter(
    !grepl('Schedules', issues)
  )
```

### DB Functions

```{r, eval = FALSE}
# DB Functions

data <- dbGetQuery(con, 'select * from iris')
dbListTables(con) %>% sort
dbExistsTable(con, "iris")
dbRemoveTable(con, "iris")
```

### Knitr

```{r, eval = F}
knitr::include_graphics(rep("./assets/ml_trading/portfolio.png", 3))
```

## Bash

script to do joining of dummied csvs

```{bash, eval = F}
paste -d=',' file1.csv file2.csv file3.csv > file_final.csv
```

